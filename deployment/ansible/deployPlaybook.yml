---
- hosts: djangoserver
  tasks:
    - name: Create erpnetwork (if it doesn't exist)
      docker_network:
        name: erpnetwork
        state: present
      become: yes

    - name: Stop and remove containers with image prefix 'gitauwairimu/djangoscherp-dev'
      docker_container:
        state: absent
        force: yes  # Forcefully stop container before removal (optional)
      filters:
        image: "{{ 'gitauwairimu/djangoscherp-dev:*' }}"  # Filter by image name prefix

    - name: Remove images starting with 'gitauwairimu/djangoscherp-dev'
      docker_image:
        name: "{{ image.name }}"
        state: absent
      loop: "{{ docker_images.results }}"
      when: image.name.startswith("gitauwairimu/djangoscherp-dev")


    - name: Run djangoscherp-dev container
      docker_container:
        name: django-erp
        image: gitauwairimu/djangoscherp-dev:latest
        ports:
          - container_port: 8000
            host_port: 80
        volumes:
          - "{{ lookup('env', 'DJANGO_DATA_DIR') }}:/app/data"
        networks:
          - name: erpnetwork
        state: started
