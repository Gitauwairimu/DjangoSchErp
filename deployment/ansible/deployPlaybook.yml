---
- hosts: django_server
  become: true  # Assuming privilege escalation required
  gather_facts: false  # Disable fact gathering

  tasks:
    - name: Update package repositories (adjust based on your distro)
      apt:  # Replace with yum or dnf for other distributions
        update_cache: yes
        cache_valid_time: 3600  # Optional: Cache updates for 1 hour

    - name: Upgrade all packages
      apt:  # Replace with yum or dnf for other distributions
        upgrade: yes
        force_apt_lock: yes  # Optional: Avoid dependency conflicts

    - name: Ensure Docker is installed
      apt:  # Replace with yum or dnf for other distributions
        name: docker.io
        state: present

    - name: Create erpnetwork (if it doesn't exist)
      docker_network:
        name: erpnetwork
        state: present

    - name: Stop and remove djangoscherp-dev containers
      docker_container:
        state: absent
        force: yes  # Forcefully stop container before removal (optional)
        filters:
          image: "{{ 'gitauwairimu/djangoscherp-dev:*' }}"

    - name: Remove images starting with 'gitauwairimu/djangoscherp-dev'
      docker_image:
        name: "{{ image.name }}"
        state: absent
        loop: "{{ docker_images.results }}"
        when: image.name.startswith("gitauwairimu/djangoscherp-dev")

    - name: Run djangoscherp-dev container
      docker_container:
        name: django-erp
        image: gitauwairimu/djangoscherp-dev:latest
        ports:
          - container_port: 8000

