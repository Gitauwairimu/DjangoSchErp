---
- hosts: django_server

  collections:
      - community.docker
  become: true  # Assuming privilege escalation required
  gather_facts: true  # Enable fact gathering

  tasks:

    - name: Install aptitude
      apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: Install required system packages
      apt:
        pkg:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - python3-pip
          - virtualenv
          - python3-setuptools
        state: latest
        update_cache: true

    - name: Add Docker GPG apt Key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker Repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Update apt and install docker-ce
      apt:
        name: docker-ce
        state: latest
        update_cache: true

    - name: Install Docker Module for Python
      pip:
        name: docker

    - name: Create erpnetwork (if it doesn't exist)
      docker_network:
        name: erpnetwork
        state: present


    - name: Stop and remove existing djangoscherp-dev containers
      docker_container:
        state: absent
        name: django-erp
        force_kill: yes  # Forcefully stop container before removal (optional)
       
    - name: Build dynamic image tag
      set_fact:
        image_tag: "gitauwairimu/djangoscherp-dev:{{ lookup('env', 'GITHUB_RUN_ID') }}"  # Access CI_RUN_ID environment variable

    - name: Ensure container is running
      docker_container:
        name: django-erp
        image: "{{ image_tag }}"  # Use the constructed image_tag variable
        pull: true
        ports:
          - "80:8000"

    - name: docker container ls -a
      tags: container_ls
      become: True
      shell:
        "docker container ls -a"
      register: container_info

    - name: docker container ls -a result
      tags: container_ls
      debug:
        msg: "{{container_info.stdout_lines}}"

    - name: Get all Docker images
      docker_image_info:
      register: docker_images


    - name: Print images information (optional)
      debug:
        msg: "Existing images: {{ docker_images.results }}"

    - name: Clean up Docker images
      docker_prune:
        images: yes
        images_filters:
          dangling: false

    - name: Get all Docker images
      docker_image_info:
      register: docker_images


    - name: Print images information (optional)
      debug:
        msg: "Existing images: {{ docker_images.results }}"